Title: Improvements to asyncio Task Cancellation Handling
URL: https://docs.python.org/3/whatsnew/changelog.html
Summary: The updates ensure that an `asyncio.CancelledError` will be raised at the next `await`, preventing cancellation loss. Task groups now retain the cancellation count, and `asyncio.Task.uncancel()` can reset the `_must_cancel` flag under specific conditions. Additionally, `typing.TypeIs` has been added to implement PEP 742.
---

This ensures that a [`asyncio.CancelledError`](https://docs.python.org/3/library/asyncio-exceptions.html#asyncio.CancelledError "asyncio.CancelledError") will be raised at the next [`await`](https://docs.python.org/3/reference/expressions.html#await), so the cancellation is not lost.
An added benefit of these changes is that task groups now preserve the cancellation count ([`asyncio.Task.cancelling()`](https://docs.python.org/3/library/asyncio-task.html#asyncio.Task.cancelling "asyncio.Task.cancelling")).
In order to handle some corner cases, [`asyncio.Task.uncancel()`](https://docs.python.org/3/library/asyncio-task.html#asyncio.Task.uncancel "asyncio.Task.uncancel") may now reset the undocumented `_must_cancel` flag when the cancellation count reaches zero.
  * [gh-117516](https://github.com/python/cpython/issues/117516): Add [`typing.TypeIs`](https://docs.python.org/3/library/typing.html#typing.TypeIs "typing.TypeIs"), implementing [**PEP 742**](https://peps.python.org/pep-0742/). Patch by Jelle Zijlstra.
  * [gh-117503](https://github.com/python/cpython/issues/117503): Fix support of non-ASCII user names in bytes paths in [`os.path.expanduser()`](https://docs.python.org/3/library/os.path.html#os.path.expanduser "os.path.expanduser") on Posix.
  * [gh-117394](https://github.com/python/cpython/issues/117394): [`os.path.ismount()`](https://docs.python.org/3/library/os.path.html#os.path.ismount "os.path.ismount") is now 2-3 times faster if the user has permissions.
  * [gh-117313](https://github.com/python/cpython/issues/117313): Only treat `'\n'`, `'\r'` and `'\r\n'` as line separators in re-folding the [`email`](https://docs.python.org/3/library/email.html#module-email "email: Package supporting the parsing, manipulating, and generating email messages.") messages. Preserve control characters `'\v'`, `'\f'`, `'\x1c'`, `'\x1d'` and `'\x1e'` and Unicode line separators `'\x85'`, `'\u2028'` and `'\u2029'` as is.
  * [gh-117142](https://github.com/python/cpython/issues/117142): Convert `_ctypes` to multi-phase initialisation ([**PEP 489**](https://peps.python.org/pep-0489/)).
  * [gh-66543](https://github.com/python/cpython/issues/66543): Add the [`mimetypes.guess_file_type()`](https://docs.python.org/3/library/mimetypes.html#mimetypes.guess_file_type "mimetypes.guess_file_type") function which works with file path. Passing file path instead of URL in [`guess_type()`](https://docs.python.org/3/library/mimetypes.html#mimetypes.guess_type "mimetypes.guess_type") is [soft deprecated](https://docs.python.org/3/glossary.html#term-soft-deprecated).
  * [gh-68583](https://github.com/python/cpython/issues/68583): webbrowser CLI: replace getopt with argparse, add long options. Patch by Hugo van Kemenade.
  * [gh-116871](https://github.com/python/cpython/issues/116871): Name suggestions for [`AttributeError`](https://docs.python.org/3/library/exceptions.html#AttributeError "AttributeError") and [`ImportError`](https://docs.python.org/3/library/exceptions.html#ImportError "ImportError") now only include underscored names if the original name was underscored.
  * [gh-116023](https://github.com/python/cpython/issues/116023): Donâ€™t show empty fields (value `None` or `[]`) in [`ast.dump()`](https://docs.python.org/3/library/ast.html#ast.dump "ast.dump") by default. Add `show_empty=False` parameter to optionally show them.
  * [gh-115961](https://github.com/python/cpython/issues/115961): Added `name` and `mode` attributes for compressed and archived file-like objects in modules [`bz2`](https://docs.python.org/3/library/bz2.html#module-bz2 "bz2: Interfaces for bzip2 compression and decompression."), [`lzma`](https://docs.python.org/3/library/lzma.html#module-lzma "lzma: A Python wrapper for the liblzma compression library."), [`tarfile`](https://docs.python.org/3/library/tarfile.html#module-tarfile "tarfile: Read and write tar-format archive files.") and [`zipfile`](https://docs.python.org/3/library/zipfile.html#module-zipfile "zipfile: Read and write ZIP-format archive files."). The value of the `mode` attribute of [`gzip.GzipFile`](https://docs.python.org/3/library/gzip.html#gzip.GzipFile "gzip.GzipFile") was changed from integer (`1` or `2`) to string (`'rb'` or `'wb'`).